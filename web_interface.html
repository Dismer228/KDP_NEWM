<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lithuanian Voice Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .voice-selector {
            display: grid;
            gap: 10px;
        }
        
        .voice-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voice-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .voice-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .voice-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        audio {
            width: 100%;
            margin-top: 15px;
        }
        
        #status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        #status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        #status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        #status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .service-status {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .service {
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .service.online {
            border-color: #28a745;
        }
        
        .service.offline {
            border-color: #dc3545;
        }
        
        .service h3 {
            font-size: 1em;
            margin-bottom: 5px;
        }
        
        .service .status {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üá±üáπ Lithuanian Voice Assistant</h1>
            <p>Speech Recognition + Text-to-Speech</p>
        </div>
        
        <!-- Service Status -->
        <div class="service-status">
            <div class="service" id="ultravox-status">
                <h3>üé§ Speech Recognition</h3>
                <div class="status">Checking...</div>
            </div>
            <div class="service" id="tts-status">
                <h3>üîä Text-to-Speech</h3>
                <div class="status">Checking...</div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Text-to-Speech Section -->
            <div class="section">
                <h2>üîä Text-to-Speech</h2>
                <div class="input-group">
                    <label for="ttsText">Enter Lithuanian text:</label>
                    <textarea id="ttsText" placeholder="ƒÆveskite lietuvi≈°kƒÖ tekstƒÖ ƒçia...">Sveiki! Kaip laikaisi ≈°iandien?</textarea>
                </div>
                
                <div class="input-group">
                    <label>Select Voice:</label>
                    <div class="voice-selector">
                        <div class="voice-option selected">
                            <input type="radio" name="voice" value="lt-LT-LeonasNeural" id="leonas" checked>
                            <label for="leonas" style="margin: 0; cursor: pointer;">üôã‚Äç‚ôÇÔ∏è Leonas (Male)</label>
                        </div>
                        <div class="voice-option">
                            <input type="radio" name="voice" value="lt-LT-OnaNeural" id="ona">
                            <label for="ona" style="margin: 0; cursor: pointer;">üôã‚Äç‚ôÄÔ∏è Ona (Female)</label>
                        </div>
                    </div>
                </div>
                
                <button onclick="synthesizeSpeech()">üîä Generate Speech</button>
                <button onclick="downloadAudio()" id="downloadBtn" style="background: #28a745; display: none;">‚¨áÔ∏è Download MP3</button>
                
                <audio id="audioPlayer" controls style="display: none;"></audio>
            </div>
            
            <!-- Speech-to-Text Section -->
            <div class="section">
                <h2>üé§ Speech-to-Text</h2>
                <div class="input-group">
                    <label for="audioFile">Upload audio file (WAV, MP3):</label>
                    <input type="file" id="audioFile" class="file-input" accept="audio/*" onchange="handleFileSelect(event)">
                    <label for="audioFile" class="file-label">üìÅ Choose Audio File</label>
                    <span id="fileName" style="margin-left: 10px; color: #666;"></span>
                </div>
                
                <button onclick="transcribeAudio()">üìù Transcribe</button>
                
                <div class="input-group" style="margin-top: 20px;">
                    <label>Transcription Result:</label>
                    <textarea id="transcriptionResult" readonly placeholder="Transcription will appear here..."></textarea>
                </div>
            </div>
            
            <!-- Complete Voice Pipeline -->
            <div class="section full-width">
                <h2>üéôÔ∏è Complete Voice Assistant</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Upload audio ‚Üí Get transcription ‚Üí Generate AI response ‚Üí Hear response
                </p>
                
                <div class="input-group">
                    <label for="voiceInput">Upload your question (audio):</label>
                    <input type="file" id="voiceInput" class="file-input" accept="audio/*" onchange="handleVoiceInput(event)">
                    <label for="voiceInput" class="file-label">üé§ Upload Audio Question</label>
                    <span id="voiceFileName" style="margin-left: 10px; color: #666;"></span>
                </div>
                
                <button onclick="processVoiceQuery()">üöÄ Process Complete Query</button>
                
                <div id="pipelineResult" style="margin-top: 20px; display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p><strong>Your question:</strong> <span id="userQuestion"></span></p>
                        <p style="margin-top: 10px;"><strong>Assistant's response:</strong> <span id="assistantResponse"></span></p>
                        <audio id="responseAudio" controls style="margin-top: 10px; width: 100%;"></audio>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="status"></div>
    </div>

    <script>
        const ULTRAVOX_URL = 'http://localhost:8000';
        const TTS_URL = 'http://localhost:5003';
        let currentAudioBlob = null;
        let selectedFile = null;
        let voiceQueryFile = null;
        
        // Initialize
        window.addEventListener('load', checkServices);
        
        // Voice option selection
        document.querySelectorAll('.voice-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.voice-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });
        
        async function checkServices() {
            // Check Ultravox
            try {
                const response = await fetch(`${ULTRAVOX_URL}/health`);
                const data = await response.json();
                document.getElementById('ultravox-status').classList.add('online');
                document.getElementById('ultravox-status').querySelector('.status').textContent = 
                    `‚úÖ Online - ${data.device || 'CPU'}`;
            } catch (error) {
                document.getElementById('ultravox-status').classList.add('offline');
                document.getElementById('ultravox-status').querySelector('.status').textContent = 
                    '‚ùå Offline - Start with: docker-compose up -d ultravox';
            }
            
            // Check TTS
            try {
                const response = await fetch(`${TTS_URL}/health`);
                const data = await response.json();
                document.getElementById('tts-status').classList.add('online');
                document.getElementById('tts-status').querySelector('.status').textContent = 
                    `‚úÖ Online - ${data.method || 'REST API'}`;
            } catch (error) {
                document.getElementById('tts-status').classList.add('offline');
                document.getElementById('tts-status').querySelector('.status').textContent = 
                    '‚ùå Offline - Start with: docker-compose up -d azure-tts-proxy';
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
            setTimeout(() => status.style.display = 'none', 5000);
        }
        
        async function synthesizeSpeech() {
            const text = document.getElementById('ttsText').value;
            const voice = document.querySelector('input[name="voice"]:checked').value;
            
            if (!text.trim()) {
                showStatus('Please enter some text', 'error');
                return;
            }
            
            showStatus('Generating speech...', 'info');
            
            try {
                const response = await fetch(`${TTS_URL}/synthesize`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text, voice, rate: '0%', pitch: '0%'})
                });
                
                if (!response.ok) throw new Error('TTS request failed');
                
                const data = await response.json();
                const audioBytes = atob(data.audio_base64);
                const audioArray = new Uint8Array(audioBytes.length);
                for (let i = 0; i < audioBytes.length; i++) {
                    audioArray[i] = audioBytes.charCodeAt(i);
                }
                currentAudioBlob = new Blob([audioArray], { type: 'audio/mp3' });
                
                const audioUrl = URL.createObjectURL(currentAudioBlob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                audioPlayer.play();
                
                document.getElementById('downloadBtn').style.display = 'inline-block';
                showStatus('‚úÖ Speech generated successfully!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error generating speech. Make sure Azure TTS server is running.', 'error');
            }
        }
        
        function downloadAudio() {
            if (!currentAudioBlob) {
                showStatus('No audio to download', 'error');
                return;
            }
            
            const url = URL.createObjectURL(currentAudioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lithuanian_speech.mp3';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Audio downloaded!', 'success');
        }
        
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('fileName').textContent = selectedFile.name;
            }
        }
        
        function handleVoiceInput(event) {
            voiceQueryFile = event.target.files[0];
            if (voiceQueryFile) {
                document.getElementById('voiceFileName').textContent = voiceQueryFile.name;
            }
        }
        
        async function transcribeAudio() {
            if (!selectedFile) {
                showStatus('Please select an audio file first', 'error');
                return;
            }
            
            showStatus('Transcribing audio...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('audio', selectedFile);
                formData.append('language', 'lt');
                
                const response = await fetch(`${ULTRAVOX_URL}/transcribe`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Transcription request failed');
                
                const data = await response.json();
                document.getElementById('transcriptionResult').value = data.transcription;
                
                showStatus('‚úÖ Transcription completed!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error transcribing audio. Make sure Ultravox server is running.', 'error');
            }
        }
        
        async function processVoiceQuery() {
            if (!voiceQueryFile) {
                showStatus('Please upload an audio file first', 'error');
                return;
            }
            
            const pipelineResult = document.getElementById('pipelineResult');
            pipelineResult.style.display = 'none';
            showStatus('Processing your query...', 'info');
            
            try {
                // Step 1: Transcribe
                const formData = new FormData();
                formData.append('audio', voiceQueryFile);
                formData.append('language', 'lt');
                
                const transcribeResponse = await fetch(`${ULTRAVOX_URL}/transcribe`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!transcribeResponse.ok) throw new Error('Transcription failed');
                
                const transcription = await transcribeResponse.json();
                const userText = transcription.transcription;
                
                document.getElementById('userQuestion').textContent = userText;
                
                // Step 2: Generate response (simple echo for demo)
                const responseText = `Supratau! J≈´s pasakƒóte: ${userText}`;
                document.getElementById('assistantResponse').textContent = responseText;
                
                // Step 3: Generate speech
                const ttsResponse = await fetch(`${TTS_URL}/synthesize`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: responseText,
                        voice: 'lt-LT-OnaNeural',
                        rate: '0%',
                        pitch: '0%'
                    })
                });
                
                if (!ttsResponse.ok) throw new Error('TTS failed');
                
                const ttsData = await ttsResponse.json();
                const audioBytes = atob(ttsData.audio_base64);
                const audioArray = new Uint8Array(audioBytes.length);
                for (let i = 0; i < audioBytes.length; i++) {
                    audioArray[i] = audioBytes.charCodeAt(i);
                }
                const audioBlob = new Blob([audioArray], { type: 'audio/mp3' });
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const responseAudio = document.getElementById('responseAudio');
                responseAudio.src = audioUrl;
                
                pipelineResult.style.display = 'block';
                responseAudio.play();
                
                showStatus('‚úÖ Complete! Listen to the response above.', 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error processing query: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
